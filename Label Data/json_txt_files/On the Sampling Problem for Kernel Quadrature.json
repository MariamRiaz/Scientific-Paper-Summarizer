{"sections": [{"heading": "1. INTRODUCTION", "text": "Consider approximation of the Lebesgue integral\n\u03a0(f) = \u222b X fd\u03a0 (1)\nwhere \u03a0 is a Borel measure defined over X \u2286 Rd and f is Borel measurable. Define P(f) to be the set of Borel measures \u03a0\u2032 such that f \u2208 L2(\u03a0\u2032), meaning that \u2016f\u20162L2(\u03a0\u2032) = \u222b X f\n2d\u03a0\u2032 < \u221e, and assume \u03a0 \u2208 P(f). In situations where \u03a0(f) does not admit a closed-form, Monte\n1University of Warwick, Department of Statistics. 2Imperial College London, Department of Mathematics. 3Newcastle University, School of Mathematics and Statistics 4The Alan Turing Institute for Data Science 5University of Technology Sydney, School of Mathematical and Physical Sciences. Correspondence to: Franc\u0327ois-Xavier Briol <f-x.briol@warwick.ac.uk>.\nProceedings of the 34 th International Conference on Machine Learning, Sydney, Australia, PMLR 70, 2017. Copyright 2017 by the author(s).\nCarlo (MC) methods can be used to estimate the numerical value of Eqn. 1. A classical research problem in computational statistics is to reduce the MC estimation error in this context, where the integral can, for example, represent an expectation or marginalisation over a random variable of interest.\nThe default MC estimator comprises of\n\u03a0\u0302MC(f) = 1\nn n\u2211 j=1 f(xj),\nwhere xj are sampled identically and independently (i.i.d.) from \u03a0. Then we have a root mean square error (RMSE) bound \u221a\nE[\u03a0\u0302MC(f)\u2212\u03a0(f)]2 \u2264 CMC(f ; \u03a0)\u221a\nn ,\nwhere CMC(f ; \u03a0) = Std(f ; \u03a0) and the expectation is with respect to the joint distribution of the {xj}nj=1. For settings where the Lebesgue density of \u03a0 is only known up to normalising constant, Markov chain Monte Carlo (MCMC) methods can be used; the rate-constant CMC(f ; \u03a0) is then related to the asymptotic variance of f under the Markov chain sample path.\nConsiderations of computational cost place emphasis on methods to reduce the rate constant CMC(f ; \u03a0). For the MC estimator, this rate constant can be made smaller via importance sampling (IS): f 7\u2192 f \u00b7 d\u03a0/d\u03a0\u2032 where an optimal choice \u03a0\u2032 \u2208 P(f \u00b7 d\u03a0/d\u03a0\u2032), that minimises Std(f \u00b7 d\u03a0/d\u03a0\u2032; \u03a0\u2032), is available in explicit closed-form (see Robert and Casella, 2013, Thm. 3.3.4). However, the RMSE remains asymptotically gated at O(n\u22121/2).\nThe default Kernel Quadrature (KQ) estimate comprises of\n\u03a0\u0302(f) = n\u2211 j=1 wjf(xj), (2)\nwhere the xj \u223c \u03a0\u2032 are independent (or arise from a Markov chain) and supp(\u03a0) \u2286 supp(\u03a0\u2032). In contrast to MC, the weights {wj}nj=1 in KQ are in general non-uniform, real-valued and depend on {xj}nj=1. The KQ nomenclature derives from the (symmetric, positivedefinite) kernel k : X \u00d7 X \u2192 R that is used to construct an interpolant f\u0302(x) = \u2211n j=1 \u03b2jk(x,xj) such that\nf\u0302(xj) = f(xj) for j = 1, . . . , n. The weights wj in Eqn. 2 are implicitly defined via the equation \u03a0\u0302(f) = \u222b X f\u0302d\u03a0. The KQ estimator is identical to the posterior mean in Bayesian Monte Carlo (O\u2019Hagan, 1991; Rasmussen and Ghahramani, 2002), and its relationship with classical numerical quadrature rules has been studied (Diaconis, 1988; Sa\u0308rkka\u0308 et al., 2015).\nUnder regularity conditions, Briol et al. (2015b) established the following RMSE bound for KQ:\u221a\nE[\u03a0\u0302(f)\u2212\u03a0(f)]2 \u2264 C(f ; \u03a0 \u2032)\nns/d\u2212 , (s > d/2)\nwhere both the integrand f and each argument of the kernel k admit continuous mixed weak derivatives of order s and > 0 can be arbitrarily small. An information-theoretic lower bound on the RMSE is O(n\u2212s/d\u22121/2) (Bakhvalov, 1959). The faster convergence of the RMSE, relative to MC, can lead to improved precision in applications. Akin to IS, the samples {xj}nj=1 need not be draws from \u03a0 in order for KQ to provide consistent estimation (since \u03a0 is encoded in the weights wj). Importantly, KQ can be viewed as post-processing of MC samples; the kernel k can be reverse-engineered (e.g. via cross-validation) and does not need to be specified up-front.\nOne notable disadvantage of KQ methods is that little is known about how the rate constant C(f ; \u03a0\u2032) depends on the choice of sampling distribution \u03a0\u2032. In contrast to IS, no general closed-form expression has been established for an optimal distribution \u03a0\u2032 for KQ (the technical meaning of \u2018optimal\u2019 is defined below). Moreover, limited practical guidance is available on the selection of the sampling distribution (an exception is Bach, 2015, as explained in Sec. 2.4) and in applications it is usual to take \u03a0\u2032 = \u03a0. This choice is convenient but leads to estimators that are not efficient, as we demonstrate in dramatic empirical examples in Sec. 2.3.\nThe main contributions of this paper are twofold. First, we formalise the problem of optimal sampling for KQ as an important and open challenge in computational statistics. To be precise, our target is an optimal sampling distribution for KQ, defined as\n\u03a0\u2217 \u2208 arg min \u03a0\u2032 sup f\u2208F\n\u221a E[\u03a0\u0302(f)\u2212\u03a0(f)]2. (3)\nfor some functional class F to be specified. In general a (possibly non-unique) optimal \u03a0\u2217 will depend on F and, unlike for IS, also on the kernel k and the number of samples n.\nSecond, we propose a novel and automatic method for selection of \u03a0\u2032 that is rooted in approximation of the unavailable \u03a0\u2217. In brief, our method considers candidate sampling\ndistributions of the form \u03a0\u2032 = \u03a01\u2212t0 \u03a0 t for t \u2208 [0, 1] and \u03a00 a reference distribution on X . The exponent t is chosen such that \u03a0\u2032 minimises an empirical upper bound on the RMSE. The overall approach is facilitated with an efficient sequential MC (SMC) sampler and called SMC-KQ. In particular, the approach (i) provides practical guidance for selection of \u03a0\u2032 for KQ, (ii) offers robustness to kernel misspecification, and (iii) extends recent work on computing posterior expectations with kernels obtained using Stein\u2019s method (Oates et al., 2017).\nThe paper proceeds as follows: Empirical results in Sec. 2 reveal that the RMSE for KQ is highly sensitive to the choice of \u03a0\u2032. The proposed approach to selection of \u03a0\u2032 is contained in Sec. 3. Numerical experiments, presented in Sec. 4, demonstrate that dramatic reductions in integration error (up to 4 orders of magnitude) can be achieved with SMC-KQ. Lastly, a discussion is provided in Sec. 5."}, {"heading": "2. BACKGROUND", "text": "This section presents an overview of KQ (Sec. 2.1 and 2.2), empirical (Secs. 2.3) and theoretical (Sec. 2.4) results on the choice of sampling distribution, and discusses kernel learning for KQ (Sec. 2.5)."}, {"heading": "2.1. Overview of Kernel Quadrature", "text": "We now proceed to describe KQ: Recall the approximation f\u0302 to f ; an explicit form for the coefficients \u03b2j is given as \u03b2 = K\u22121f , where Ki,j = k(xi,xj) and fj = f(xj). It is assumed that K\u22121 exists almost surely; for non-degenerate kernels, this corresponds to \u03a0 having no atoms. From the above definition of KQ,\n\u03a0\u0302(f) = n\u2211 j=1 \u03b2j \u222b X k(x,xj)\u03a0(dx).\nDefining zj = \u222b X k(\u00b7,xj)d\u03a0 leads to the estimate in Eqn. 2 with weights w = K\u22121z. Pairs (\u03a0, k) for which the zj have closed form are reported in Table 1 of Briol et al. (2015b). Computation of these weights incurs a computational cost of at most O(n3) and can be justified when either (i) evaluation of f forms the computational bottleneck, or (ii) the gain in estimator precision (as a function in n) dominates this cost (i.e. whenever s/d > 3 + 1/2).\nNotable contributions on KQ include Diaconis (1988); O\u2019Hagan (1991); Rasmussen and Ghahramani (2002) who introduced the method and Huszar and Duvenaud (2012); Osborne et al. (2012a;b); Gunter et al. (2014); Bach (2015); Briol et al. (2015a;b); Sa\u0308rkka\u0308 et al. (2015); Kanagawa et al. (2016); Liu and Lee (2017) who provided consequent methodological extensions. KQ has been applied to a wide range of problems including probabilistic ODE\nsolvers (Kersting and Hennig, 2016), reinforcement learning (Paul et al., 2016), filtering (Pru\u0308her and S\u030cimandl, 2015) and design of experiments (Ma et al., 2014).\nSeveral characterisations of the KQ estimator are known and detailed below. LetH denote the Hilbert space characterised by the reproducing kernel k, and denote its norm as \u2016 \u00b7 \u2016H (Berlinet and Thomas-Agnan, 2011). Then we have the following: (a) The function f\u0302 is the minimiser of \u2016g\u2016H over g \u2208 H subject to g(xj) = f(xj) for all j = 1, . . . , n. (b) The function f\u0302 is the posterior mean for f under the Gaussian process prior f \u223c GP(0, k) conditioned on data f and \u03a0\u0302(f) is the mean of the implied posterior marginal over \u03a0[f ]. (c) The weightsw are characterised as the minimiser over \u03b3 \u2208 Rn of\nen(\u03b3; {xj}nj=1) = sup \u2016f\u2016H=1 \u2223\u2223\u2223\u2223\u2223 n\u2211 j=1 \u03b3jf(xj)\u2212\u03a0(f) \u2223\u2223\u2223\u2223\u2223, the maximal error in the unit ball of H. These characterisations connect KQ to (a) non-parametric regression, (b) probabilistic integration and (c) quasi-Monte Carlo (QMC) methods (Dick and Pillichshammer, 2010). The scattered data approximation literature (Sommariva and Vianello, 2006) and the numerical analysis literature (where KQ is known as the \u2018empirical interpolation method\u2019; Eftang and Stamm, 2012; Kristoffersen, 2013) can also be connected to KQ. However, our search of all of these literatures did not yield guidance on the optimal selection of the sampling distribution \u03a0\u2032 (with the exception of Bach (2015) reported in Sec. 2.4)."}, {"heading": "2.2. Over-Reliance on the Kernel", "text": "In Osborne et al. (2012a); Huszar and Duvenaud (2012); Gunter et al. (2014); Briol et al. (2015a), the selection ofxn was approached as a greedy optimisation problem, wherein the maximal integration error en(w; {xj}nj=1) was minimised, given the location of the previous {xj}n\u22121j=1 . This approach has demonstrated considerable success in applications. However, the error criterion en is strongly dependant on the choice of kernel k and the sequential optimisation approach is vulnerable to kernel misspecification. In particular, if the intrinsic length scale of k is \u201ctoo small\u201d then the {xj}nj=1 all cluster around the mode of \u03a0, leading to poor integral estimation (see Fig. 5 in the Appendix). Related work on sub-sample selection, such as leverage scores (Bach, 2013), can also be non-robust to mis-specified kernels. The partial solution of online kernel learning requires a sufficient number n of data and is not always practicable in small-n regimes that motivate KQ.\nThis paper considers sampling methods as a robust alternative to optimisation methods. Although our method also makes use of k to select \u03a0\u2032, it reverts to \u03a0\u2032 = \u03a0 in the\nlimit as the length scale of k is made small. In this sense, sampling offers more robustness to kernel mis-specification than optimisation methods, at the expense of a possible (non-asymptotic) decrease in precision in the case of a well-specified kernel. This line of research is thus complementary to existing work. However, we emphasise that robustness is an important consideration for general applications of KQ in which kernel specification may be a nontrivial task."}, {"heading": "2.3. Sensitivity to the Sampling Distribution", "text": "To date, we are not aware of a clear demonstration of the acute dependence of the performance of the KQ estimator on the choice of distribution \u03a0\u2032. It is therefore important to illustrate this phenomenon in order to build intuition.\nConsider the toy problem with state space X = R, target distribution \u03a0 = N(0, 1), a single test function f(x) = 1 + sin(2\u03c0x) and kernel k(x, x\u2032) = exp(\u2212(x\u2212 x\u2032)2). For this problem, consider a range of sampling distributions of the form \u03a0\u2032 = N(0, \u03c32) for \u03c3 \u2208 (0,\u221e). Fig. 1 plots\nR\u0302n,\u03c3 = \u221a\u221a\u221a\u221a 1 M M\u2211 m=1 (\u03a0\u0302n,m,\u03c3(f)\u2212\u03a0(f))2,\nan empirical estimate for the RMSE where \u03a0\u0302n,m,\u03c3(f) is the mth of M independent KQ estimates for \u03a0(f) based on n samples drawn from the distribution \u03a0\u2032 with standard deviation \u03c3 (M = 1000). In this case \u03a0(f) = 1 is available in closed-form. It is seen that the \u2018obvious\u2019 choice of \u03c3 = 1, i.e. \u03a0\u2032 = \u03a0, is sub-optimal. The intuition here is that \u2018extreme\u2019 samples xi from the tails of \u03a0 are rather informative for building the interpolant f\u0302 underlying KQ; we should therefore over-sample these values via a heaviertailed \u03a0\u2032. The same intuition is used for column sampling and to construct leverage scores (Mahoney, 2011; Drineas et al., 2012)."}, {"heading": "2.4. Established Results", "text": "Here we recall the main convergence results to-date on KQ and discuss how these relate to choices of sampling distribution. To reduce the level of detail below, we make several assumptions at the outset:\nAssumption on the domain: The domain X will either be Rd itself or a compact subset of Rd that satisfies an \u2018interior cone condition\u2019, meaning that there exists an angle \u03b8 \u2208 (0, \u03c0/2) and a radius r > 0 such that for every x \u2208 X there exists \u2016\u03be\u20162 = 1 such that the cone {x + \u03bby : y \u2208 Rd, \u2016y\u20162 = 1, yT \u03be \u2265 cos \u03b8, \u03bb \u2208 [0, r]} is contained in X (see Wendland, 2004, for background).\nAssumption on the kernel: Consider the integral operator \u03a3 : L2(\u03a0) \u2192 L2(\u03a0), with (\u03a3f)(x) defined as the\nBochner integral \u222b X f(x\n\u2032)k(x,x\u2032)\u03a0(dx\u2032). Assume that\u222b X k(x,x)\u03a0(dx) < \u221e, so that \u03a3 is self-adjoint, positive semi-definite and trace-class (Simon, 1979). Then, from an extension of Mercer\u2019s theorem (Ko\u0308nig, 1986) we have a decomposition k(x,x\u2032) = \u2211\u221e m=1 \u00b5mem(x)em(x\n\u2032), where \u00b5m and em(x) are the eigenvalues and eigenfunctions of \u03a3. Further assume thatH is dense in L2(\u03a0).\nThe first result is adapted and extended from Thm. 1 in Oates et al. (2016).\nTheorem 1. Assume that \u03a0\u2032 admits a density \u03c0\u2032 defined on a compact domain X . Assume that \u03c0\u2032 > c for some c > 0. Let x1, . . . ,xm be fixed and define the Euclidean fill distance\nhm = sup x\u2208X min j=1,...,m\n\u2016x\u2212 xj\u20162.\nLet xm+1, . . . ,xn be independent draws from \u03a0\u2032. Assume k gives rise to a Sobolev space Hs(\u03a0). Then there exists h0 > 0 such that, for hm < h0,\u221a\nE[\u03a0\u0302(f)\u2212\u03a0(f)]2 \u2264 C(f)n\u2212s/d+\nfor all > 0. Here C(f) = ck,\u03a0\u2032, \u2016f\u2016H for some constant 0 < ck,\u03a0\u2032, <\u221e independent of n and f .\nAll proofs are reserved for the Appendix. The main contribution of Thm. 1 is to establish a convergence rate for KQ when using importance sampling distributions. A similar result appeared in Thm. 1 of Briol et al. (2015b) for samples from \u03a0 (see the Appendix) and was extended to MCMC samples in Oates et al. (2016). An extension to\nthe case of a mis-specified kernel was considered in Kanagawa et al. (2016). However a limitation of this direction of research is that it does not address the question of how to select \u03a0\u2032.\nThe second result that we present is a consequence of the recent work of Bach (2015), who considered a particular choice of \u03a0\u2032 = \u03a0B, depending on a fixed \u03bb > 0, via the density \u03c0B(x;\u03bb) \u221d \u2211\u221e m=1 \u00b5m \u00b5m+\u03bb\ne2m(x). The following is adapted from Prop. 1 in Bach (2015): Theorem 2. Let x1, . . . ,xn \u223c \u03a0B be independent and \u03bb > 0. For \u03b4 \u2208 (0, 1) and n \u2265 5d(\u03bb) log 16d(\u03bb)\u03b4 , d(\u03bb) = \u2211\u221e m=1 \u00b5m \u00b5m+\u03bb , we have that\n|\u03a0\u0302(f)\u2212\u03a0(f)| \u2264 2\u03bb1/2\u2016f\u2016H,\nwith probability greater than 1\u2212 \u03b4.\nSome remarks are in order: (i) Bach (2015, Prop. 3) showed that, for \u03a0B, integration error scales at an optimal rate in n up to logarithmic terms and, after n samples, is of size \u221a \u00b5n. (ii) The distribution \u03a0B is obtained from minimising an upper bound on the integration error, rather than the error itself. It is unclear to us how well \u03a0B approximates an optimal sampling distribution for KQ. (iii) In general \u03a0B is hard to compute. For the specific case X = [0, 1]d, H equal to Hs(\u03a0) and \u03a0 uniform, the distribution \u03a0B is also uniform (and hence independent of n; see Sec. 4.4 of Bach (2015)). However, even for the simple example of Sec. 2.3, \u03a0B does not appear to have a closed form (details in Appendix). An approximation scheme was proposed in Sec. 4.2 of Bach (2015) but the error of this scheme was not studied.\nOptimal sampling for approximation in \u2016 \u00b7 \u2016L2(\u03a0) with weighted least squares (not in the kernel setting) was\nconsidered in Hampton and Doostan (2015); Cohen and Migliorati (2016)."}, {"heading": "2.5. Goals", "text": "Our first goal was to formalise the sampling problem for KQ; this is now completed. Our second goal was to develop a novel automatic approach to selection of \u03a0\u2032, called SMC-KQ; full details are provided in Sec. 3.\nAlso, observe that the integrand f will in general belong to an infinitude of Hilbert spaces, while for KQ a single kernel k must be selected. This choice will affect the performance of the KQ estimator; for example, in Fig. 2, the problem of Sec. 2.3 was reconsidered based on a class of kernels k(x, x\u2032) = exp(\u2212(x \u2212 x\u2032)2/`2) parametrised by ` \u2208 (0,\u221e). Results showed that, for all choices of \u03c3 parameter, the RMSE of KQ is sensitive to choice of `. In particular, the default choice of ` = 1 is not optimal. For this reason, an extension that includes kernel learning, called SMC-KQ-KL, is proposed in Sec. 3."}, {"heading": "3. METHODS", "text": "In this section the SMC-KQ and SMC-KQ-KL methods are presented. Our aim is to explain in detail the main components (SMC, temp, crit) of Alg. 1. To this end, Secs. 3.1 and 3.2 set up our SMC sampler to target tempered distributions, while Sec. 3.3 presents a heuristic for the choice of temperature schedule. Sec. 3.4 extends the approach to kernel learning and Sec. 3.5 proposes a novel criterion to determine when a desired error tolerance is reached."}, {"heading": "3.1. Thermodynamic Ansatz", "text": "To begin, consider f , k and n as fixed. The following ansatz is central to our proposed SMC-KQ method: An optimal distribution \u03a0\u2217 (in the sense of Eqn. 3) can be wellapproximated by a distribution of the form\n\u03a0t = \u03a0 1\u2212t 0 \u03a0 t, t \u2208 [0, 1] (4)\nfor a specific (but unknown) \u2018inverse temperature\u2019 parameter t = t\u2217. Here \u03a00 is a reference distribution to be specified and which should be chosen to be un-informative in practice. It is assumed that all \u03a0t exist (i.e. can be normalised). The motivation for this ansatz stems from Sec. 2.3, where \u03a0 = N(0, 1) and \u03a0t = N(0, \u03c32) can be cast in this form with t = \u03c3\u22121 and \u03a00 an (improper) uniform distribution on R. In general, tempering generates a class of distributions which over-represent extreme events relative to \u03a0 (i.e. have heavier tails). This property has the potential to improve performance for KQ, as demonstrated in Sec. 2.3.\nThe ansatz of Eqn. 4 reduces the non-parametric sampling problem for KQ to the one-dimensional parametric prob-\nlem of selecting a suitable t \u2208 [0, 1]. The problem can be further simplified by focusing on a discrete temperature ladder {ti}Ti=0 such that t0 = 0, ti < ti+1 and tT = 1. Discussion of the choice of ladder is deferred to Sec. 3.3. This reduced problem, where we seek an optimal index i\u2217 \u2208 {0, . . . , T}, is still non-trivial as no closed-form expression is available for the RMSE at each candidate ti. To overcome this impasse a novel approach to estimate the RMSE is presented in Sec. 3.5.\n3.2. Convex Ansatz (SMC)\nThe proposed SMC-KQ algorithm requires a second ansatz, namely that the RMSE is convex in t and possesses a global minimum in the range t \u2208 (0, 1). This second ansatz (borne out in numerical results in Fig. 1) motivates an algorithm that begins at t0 = 0 and tracks the RMSE until an increase is detected, say at ti; at which point the index i\u2217 = i\u2212 1 is taken for KQ.\nTo realise such an algorithm, this paper exploited SMC methods (Chopin, 2002; Del Moral et al., 2006). Here, a particle approximation {(wj ,xj)}Nj=1 to \u03a0t0 is first obtained where xj are independent draws from \u03a00, wj = N\u22121 and N n. Then, at iteration i, the particle approximation to \u03a0ti\u22121 is re-weighted, re-sampled and subject to a Markov transition, to deliver a particle approximation {(w\u2032j ,x\u2032j)}Nj=1 to \u03a0ti . This \u2018re-sample-move\u2019 algorithm, denoted SMC, is standard but, for completeness, pseudo-code is provided as Alg. 2 in the Appendix.\nAt iteration i, a subset of size n is drawn from the unique1 elements in {x\u2032j}Nj=1, from the particle approximation to \u03a0ti , and proposed for use in KQ. A criterion crit, defined in Sec. 3.5, is used to determine whether the resultant KQ error has increased relative to \u03a0ti\u22121 . If this is the case, then the distribution \u03a0ti\u22121 from the previous iteration is taken for use in KQ. Otherwise the algorithm proceeds to ti+1 and the process repeats. In the degenerate case where the RMSE has a minimum at tT , the algorithm defaults to standard KQ with \u03a0\u2032 = \u03a0.\nBoth ansatz of the SMC-KQ algorithm are justified through the strong empirical results presented in Sec. 4.\n3.3. Choice of Temperature Schedule (temp)\nThe choice of temperature schedule {ti}Ti=0 influences several aspects of SMC-KQ: (i) The SMC approximation to \u03a0ti is governed by the \u201cdistance\u201d (in some appropriate metric) between \u03a0ti\u22121 and \u03a0ti . (ii) The speed at which the minimum t\u2217 can be reached is linear in the number of\n1This ensures that kernel matrices have full rank. It does not introduce bias into KQ, since in general \u03a0\u2032 need not equal \u03a0. However, to keep notation clear, we do not make this operation explicit.\ntemperatures between 0 and t\u2217. (iii) The precision of KQ depends on the approximation t\u2217 \u2248 ti\u2217 . Factors (i,iii) motivate the use of a fine schedule with T large, while (ii) motivates a coarse schedule with T small.\nFor this work, a temperature schedule was used that is well suited to both (i) and (ii), while a strict constraint ti \u2212 ti\u22121 \u2264 \u2206 was imposed on the grid spacing to acknowledge (iii). The specific schedule used in this work was determined based on the conditional effective sample size of the current particle population, as proposed in the recent work of Zhou et al. (2016). Full details are presented in Algs. 4 and 5 in the Appendix."}, {"heading": "3.4. Kernel Learning", "text": "In Sec. 2.5 we demonstrated the benefit of kernel learning for KQ. From the Gaussian process characterisation of KQ from Sec. 2.1, it follows that kernel parameters \u03b8 can be estimated, conditional on a vector of function evaluations f , via maximum marginal likelihood:\n\u03b8\u2032 \u2190 arg max \u03b8 p(f |\u03b8) = arg min \u03b8 f>K\u22121\u03b8 f + log |K\u03b8|.\nIn SMC-KQ-KL, the function evaluations f are obtained at the first2 n (of N ) states {xj}nj=1 and the parameters \u03b8 are updated in each iteration of the SMC. This demands repeated function evaluation; this burden can be reduced with less frequent parameter updates and caching of all previous function evaluations. The experiments in Sec. 4 assessed both SMC-KQ and SMC-KQ-KL in terms of precision per total number of function evaluations, so that the additional cost of kernel learning was taken into account.\n3.5. Termination Criterion (crit)\nThe SMC-KQ-KL algorithm is designed to track the RMSE as t is increased. However, the RMSE is not available in closed form. In this section we derive a tight upper bound on the RMSE that is used for the crit component in Alg. 1.\nFrom the worst-case characterisation of KQ presented in Sec. 2.1, we have an upper bound\n|\u03a0\u0302(f)\u2212\u03a0(f)| \u2264 en(w; {xj}nj=1)\u2016f\u2016H. (5)\nThe term en(w; {xj}nj=1), denoted henceforth as en({xj}nj=1) (since w depends on {xj}nj=1), can be computed in closed form (see the Appendix). This motivates\n2This is a notational convention and is without loss of generality. In this paper these states were a random sample (without replacement) of size n, though stratified sampling among the N states could be used. More sophisticated alternatives that also involve the kernel k, such as leverage scores, were not considered, since in general these (i) introduce a vulnerability to mis-specified kernels and (ii) require manipulation of a N \u00d7 N kernel matrix (Patel et al., 2015).\nAlgorithm 1 SMC Algorithm for KQ function SMC-KQ(f,\u03a0, k,\u03a00, \u03c1, n,N) input f (integrand) input \u03a0 (target disn.) input k (kernel) input \u03a00 (reference disn.) input \u03c1 (re-sample threshold) input n (num. func. evaluations) input N (num. particles) i\u2190 0; ti \u2190 0; Rmin \u2190\u221e x\u2032j \u223c \u03a00 (initialise states \u2200j \u2208 1 : N ) w\u2032j \u2190 N\u22121 (initialise weights \u2200j \u2208 1 : N ) R\u2190 crit(\u03a0, k, {x\u2032j}Nj=1) (est\u2019d error) while test(R < Rmin) and ti < 1 do i\u2190 i+ 1; Rmin \u2190 R {(wj ,xj)}Nj=1 \u2190 {(w\u2032j ,x\u2032j)}Nj=1 ti \u2190 temp({(wj ,xj)}Nj=1, ti\u22121, \u03c1) (next temp.) {(w\u2032j ,x\u2032j)}Nj=1 \u2190 SMC({(wj ,xj)}Nj=1, ti, ti\u22121, \u03c1) (next particle approx.) R\u2190 crit(\u03a0, k, {x\u2032j}Nj=1) (est\u2019d error)\nend while fj \u2190 f(xj) (function eval. \u2200j \u2208 1 : n) zj \u2190 \u222b X k(\u00b7,xj)d\u03a0 (kernel mean eval. \u2200j \u2208 1 : n) Kj,j\u2032 \u2190 k(xj ,xj\u2032) (kernel eval. \u2200j, j\u2032 \u2208 1 : n) \u03a0\u0302(f)\u2190 z>K\u22121f (eval. KQ estimator) return \u03a0\u0302(f)\nthe following upper bound on MSE:\nE[\u03a0\u0302(f)\u2212\u03a0(f)]2 \u2264 E[en({xj}nj=1)2]\ufe38 \ufe37\ufe37 \ufe38 (\u2217) \u2016f\u20162H\ufe38 \ufe37\ufe37 \ufe38 (\u2217\u2217)\n(6)\nThe term (\u2217) can be estimated with the bootstrap approximation\nE[en({xj}nj=1)2] = M\u2211 m=1 en({x\u0303m,j}nj=1)2 M =: R2\nwhere x\u0303m,j are independent draws from {xj}Nj=1. In SMC-KQ the term (\u2217\u2217) is an unknown constant and the statistic R, an empirical proxy for the RMSE, is monitored at each iteration. The algorithm terminates once an increase in this statistic occurs. For SMC-KQ-KL the term (\u2217\u2217) is non-constant as it depends on the kernel hyper-parameters; then (\u2217\u2217) can in addition be estimated as \u2016f\u0302\u20162H = w>K\u03b8w and we monitor the product of R and \u2016f\u0302\u2016H, with termination when an increase is observed (c.f. test, defined in the Appendix).\nFull pseudo-code for SMC-KQ is provided as Alg. 1, while SMC-KQ-KL is Alg. 9 in the Appendix. To summarise, we have developed a novel procedure, SMC-KQ (and an extension SMC-KQ-KL), designed to approximate the optimal\nKQ estimator based on the unavailable optimal distribution in Eqn. 3 where F is the unit ball of H. Earlier empirical results in Sec. 2.3 suggest that SMC-KQ has potential to provide a powerful and general algorithm for numerical integration. The additional computational cost of optimising the sampling distribution does however have to be counterbalanced with the potential gain in error, and so this method will mainly be of practical interest for problems with expensive integrands or complex target distributions. The following section reports experiments designed to test this claim."}, {"heading": "4. RESULTS", "text": "Here we compared SMC-KQ (and SMC-KQ-KL) against the corresponding default approaches KQ (and KQ-KL) that are based on \u03a0\u2032 = \u03a0. Sec. 4.1 below reports an assessment in which the true value of integrals is known by design, while in Sec. 4.2 the methods were deployed to solve a parameter estimation problem involving differential equations."}, {"heading": "4.1. Simulation Study", "text": "To continue our illustration from Sec. 2, we investigated the performance of SMC-KQ and SMC-KQ-KL for integration of f(x) = 1 + sin(2\u03c0x) against the distribution \u03a0 = N(0, 1). Here the reference distribution was taken to be \u03a00 = N(0, 82). All experiments employed SMC with N = 300 particles, random walk Metropolis transitions (Alg. 3), the re-sample threshold \u03c1 = 0.95 and a maximum grid size \u2206 = 0.1. Dependence of the subsequent results on the choice of \u03a00 was investigated in Fig. 10 in the Appendix.\nFig. 3 (top) reports results for SMC-KQ against KQ, for fixed length-scale ` = 1. Corresponding results for SMC-KQ-KL against KQ-KL are shown in the bottom plot. It was observed that SMC-KQ (resp. SMC-KQ-KL) outperformed KQ (resp. KQ-KL) in the sense that, on a perfunction-evaluation basis, the MSE achieved by the proposed method was lower than for the standard method. The largest reduction in MSE achieved was about 8 orders of magnitude (correspondingly 4 orders of magnitude in RMSE). A fair approximation to the \u03c3 = 2 method, which is approximately optimal for n = 75 (c.f. results in Fig. 1), was observed. The termination criterion in Sec. 3.5 was observed to be a good approximation to the optimal temperature t\u2217 (Fig. 9 in Appendix). As an aside, we note that the MSE was gated at 10\u221216 for all methods due to numerical condition of the kernel matrix K (a known feature of the Gaussian kernel used in this experiment).\nThe investigation was extended to larger dimensions (d = 3 and d = 10) and more complex integrands f in the Ap-\npendix. In all cases, considerable improvements were obtained using SMC-KQ over KQ."}, {"heading": "4.2. Inference for Differential Equations", "text": "Consider the model given by dx/dt = f(t|\u03b8) with solution x(t|\u03b8) depending on unknown parameters \u03b8. Suppose we can obtain observations through the following noise model (likelihood): y(ti) = x(ti|\u03b8) + ei at times 0 = t1 < . . . < tn where we assume ei \u223c N(0, \u03c32) for known \u03c3 > 0. Our goal is to estimate x(T |\u03b8) for a fixed (potentially large) T > 0. To do so, we will use a Bayesian approach and specify a prior p(\u03b8), then obtain samples from the posterior \u03c0(\u03b8) := p(\u03b8|y) using MCMC. The posterior predictive mean is then defined as: \u03a0 ( x(T |\u00b7) ) = \u222b x(T |\u03b8)\u03c0(\u03b8)d\u03b8, and this can be estimated using an empirical average from the posterior samples. This type of integration problem is particularly challenging as the integrand requires simulating from the differential equation at each iteration. Furthermore, the larger T or the smaller the grid, the longer the simulation will be and the higher the computational cost.\nFor a tractable test-bed, we considered Hooke\u2019s law, given\nby the following second order homogeneous ODE given by\n\u03b85 d2x\ndt2 + \u03b84\ndx dt + \u03b83x = 0,\nwith initial conditions x(0) = \u03b81 and x\u2032(0) = \u03b82. This equation represents the evolution of a mass on a spring with friction (Robinson, 2004, Chapter 13). More precisely, \u03b83 denotes the spring constant, \u03b84 the damping coefficient representing friction and \u03b85 the mass of the object. Since this differential equation is an overdetermined system we fixed \u03b85 = 1. In this case, if \u03b824 \u2264 4\u03b83, we get a damped oscillatory behaviour as presented in Fig. 4 (top). Data were generated with \u03c3 = 0.4, (\u03b81, \u03b82, \u03b83, \u03b84) = (1, 3.75, 2.5, 0.5). with log-normal priors with scale equal to 0.5 for all parameters.\nTo implement KQ under an unknown normalisation constant for \u03a0, we followed Oates et al. (2017) and made use of a Gaussian kernel that was adapted with Stein\u2019s method (see the Appendix for details). The reference distribution \u03a00 was an wide uniform prior on the hypercube [0, 10]4. Brute force computation was used to obtain a benchmark value for the integral. For the SMC algorithm, an independent lognormal transition kernel was used at each iteration with parameters automatically tuned to the current set of particles. Results in Fig. 4 demonstrate that SMC-KQ outperforms KQ for these integration problems. These results improve upon those reported in Oates et al. (2016) for a similar integration problem based on parameter estimation for differential equations."}, {"heading": "5. DISCUSSION", "text": "In this paper we formalised the optimal sampling problem for KQ. A general, practical solution was proposed, based on novel use of SMC methods. Initial empirical results demonstrate performance gains relative to standard approach of KQ with \u03a0\u2032 = \u03a0. A more challenging example based on parameter estimation for differential equations was used to illustrate the potential of SMC-KQ for Bayesian computation in combination with Stein\u2019s method.\nOur methods were general but required user-specified choice of an initial distribution \u03a00. For compact state spaces X we recommend taking \u03a00 to be uniform. For non-compact spaces, however, there is a degree of flexibility here and default solutions, such as wide Gaussian distributions, necessarily require user input. However, the choice of \u03a00 is easier than the choice of \u03a0\u2032 itself, since \u03a00 is not required to be optimal. In our examples, improved performance (relative to standard KQ) was observed for a range of reference distributions \u03a00.\nA main motivation for this research was to provide an alternative to optimisation-based KQ that alleviates strong dependence on the choice of kernel (Sec. 2.2). This paper provides essential groundwork toward that goal, in developing sampling-based methods for KQ in the case of complex and expensive integration problems. An empirical comparison of sampling-based and optimisation-based methods is reserved for future work.\nTwo extensions of this research are identified: First, the curse of dimension that is intrinsic to standard Sobolev spaces can be alleviated by demanding \u2018dominating mixed smoothness\u2019; our methods are compatible with these (essentially tensor product) kernels (Dick et al., 2013). Second, the use of sequential QMC (Gerber and Chopin, 2015) can be considered, motivated by further orders of magnitude reduction in numerical error observed for deterministic point sets (see Fig. 13 in the Appendix)."}, {"heading": "ACKNOWLEDGEMENTS", "text": "FXB was supported by the EPSRC grant [EP/L016710/1]. CJO & MG we supported by the Lloyds Register Foundation Programme on Data-Centric Engineering. WYC was supported by the ARC Centre of Excellence in Mathematical and Statistical Frontiers. MG was supported by the EPSRC grants [EP/J016934/3, EP/K034154/1, EP/P020720/1], an EPSRC Established Career Fellowship, the EU grant [EU/259348], a Royal Society Wolfson Research Merit Award. FXB, CJO, JC & MG were also supported by the SAMSI working group on Probabilistic Numerics."}], "year": 2017, "references": [{"title": "Sharp analysis of low-rank kernel matrix approximations", "authors": ["F. Bach"], "venue": "In Proc. I. Conf. Learn. Theory,", "year": 2013}, {"title": "On the equivalence between kernel quadrature rules and random features", "authors": ["F. Bach"], "year": 2015}, {"title": "On approximate computation of integrals", "authors": ["N.S. Bakhvalov"], "venue": "Vestnik MGU, Ser. Math. Mech. Astron. Phys. Chem.,", "year": 1959}, {"title": "Reproducing kernel Hilbert spaces in probability and statistics", "authors": ["A. Berlinet", "C. Thomas-Agnan"], "venue": "Springer Science & Business Media,", "year": 2011}, {"title": "Frank-Wolfe Bayesian quadrature: Probabilistic integration with theoretical guarantees", "authors": ["F-X. Briol", "C.J. Oates", "M. Girolami", "M.A. Osborne"], "venue": "In Adv. Neur. Inf. Proc. Sys.,", "year": 2015}, {"title": "Probabilistic integration: A role for statisticians in numerical analysis", "authors": ["F-X. Briol", "C.J. Oates", "M. Girolami", "M.A. Osborne", "D. Sejdinovic"], "year": 2015}, {"title": "A sequential particle filter method for static models", "authors": ["N. Chopin"], "venue": "Biometrika, 89(3):539\u2013552,", "year": 2002}, {"title": "Optimal weighted leastsquares methods", "authors": ["A. Cohen", "G. Migliorati"], "year": 2016}, {"title": "Sequential monte carlo samplers", "authors": ["P. Del Moral", "A. Doucet", "A. Jasra"], "venue": "J. R. Stat. Soc. Ser. B. Stat. Methodol.,", "year": 2006}, {"title": "Bayesian Numerical Analysis, volume IV of Statistical Decision Theory and Related Topics, pages 163\u2013175", "authors": ["P. Diaconis"], "year": 1988}, {"title": "Digital nets and sequences: Discrepancy Theory and Quasi\u2013Monte Carlo Integration", "authors": ["J. Dick", "F. Pillichshammer"], "year": 2010}, {"title": "High-dimensional integration: The quasi-Monte Carlo way", "authors": ["J. Dick", "F.Y. Kuo", "I.H. Sloan"], "venue": "Acta Numerica,", "year": 2013}, {"title": "Fast approximation of matrix coherence and statistical leverage", "authors": ["P. Drineas", "M. Magdon-Ismail", "M.W. Mahoney", "D.P. Woodruff"], "venue": "J. Mach. Learn. Res.,", "year": 2012}, {"title": "Parameter multi-domain \u2018hp", "authors": ["J.L. Eftang", "B. Stamm"], "venue": "empirical interpolation. I. J. Numer. Methods in Eng.,", "year": 2012}, {"title": "Sequential quasi Monte Carlo", "authors": ["M. Gerber", "N. Chopin"], "venue": "J. R. Statist. Soc. B,", "year": 2015}, {"title": "Sampling for inference in probabilistic models with fast Bayesian quadrature", "authors": ["T. Gunter", "R. Garnett", "M. Osborne", "P. Hennig", "S. Roberts"], "venue": "In Adv. Neur. Inf. Proc. Sys.,", "year": 2014}, {"title": "Coherence motivated sampling and convergence analysis of least squares polynomial Chaos regression", "authors": ["J. Hampton", "A. Doostan"], "venue": "Comput. Methods Appl. Mech. Engrg.,", "year": 2015}, {"title": "Optimal importance sampling for the approximation of integrals", "authors": ["A. Hinrichs"], "venue": "J. Complexity,", "year": 2010}, {"title": "Optimally-weighted herding is Bayesian quadrature", "authors": ["F. Huszar", "D. Duvenaud"], "venue": "In Uncert. Artif. Intell.,", "year": 2012}, {"title": "Convergence guarantees for kernel-based quadrature rules in misspecified settings", "authors": ["M. Kanagawa", "B. Sriperumbudur", "K. Fukumizu"], "venue": "In Adv. Neur. Inf. Proc. Sys.,", "year": 2016}, {"title": "Active uncertainty calibration in bayesian ode solvers", "authors": ["H. Kersting", "P. Hennig"], "venue": "In Proc. Conf. Uncert. Artif. Intell.,", "year": 2016}, {"title": "Eigenvalues of compact operators with applications to integral operators", "authors": ["H. K\u00f6nig"], "venue": "Linear Algebra Appl.,", "year": 1986}, {"title": "The empirical interpolation method", "authors": ["S. Kristoffersen"], "venue": "Master\u2019s thesis, Department of Mathematical Sciences, Norwegian University of Science and Technology,", "year": 2013}, {"title": "Black-Box Importance Sampling", "authors": ["Q. Liu", "J.D. Lee"], "venue": "I. Conf. Artif. Intell. Stat.,", "year": 2017}, {"title": "Active Area Search via Bayesian Quadrature", "authors": ["Y. Ma", "R. Garnett", "J. Schneider"], "venue": "I. Conf Artif. Intell. Stat.,", "year": 2014}, {"title": "Randomized algorithms for matrices and data", "authors": ["M.W. Mahoney"], "venue": "Found. Trends Mach. Learn.,", "year": 2011}, {"title": "Convergence Rates for a Class of Estimators", "authors": ["C.J. Oates", "J. Cockayne", "F-X. Briol", "M. Girolami"], "venue": "Based on Stein\u2019s Identity", "year": 2016}, {"title": "Control Functionals for Monte Carlo Integration", "authors": ["C.J. Oates", "M. Girolami", "N. Chopin"], "venue": "J. R. Stat. Soc. Ser. B. Stat. Methodol.,", "year": 2017}, {"title": "Bayes-Hermite quadrature", "authors": ["A. O\u2019Hagan"], "venue": "J. Statist. Plann. Inference,", "year": 1991}, {"title": "Active learning of model evidence using Bayesian quadrature", "authors": ["M.A. Osborne", "D. Duvenaud", "R. Garnett", "C.E. Rasmussen", "S. Roberts", "Z. Ghahramani"], "venue": "In Adv. Neur. Inf. Proc. Sys.,", "year": 2012}, {"title": "Bayesian quadrature for ratios", "authors": ["M.A. Osborne", "R. Garnett", "S. Roberts", "C. Hart", "S. Aigrain", "N. Gibson"], "venue": "In Proc. I. Conf. Artif. Intell. Stat.,", "year": 2012}, {"title": "OASIS: Adaptive Column Sampling for Kernel Matrix Approximation", "authors": ["R. Patel", "T.A. Goldstein", "E.L. Dyer", "A.Mirhoseini", "R.G. Baraniuk"], "year": 2015}, {"title": "Alternating Optimisation and Quadrature for Robust Reinforcement Learning", "authors": ["S. Paul", "K. Ciosek", "M.A. Osborne", "S. Whiteson"], "year": 2016}, {"title": "New averaging technique for approximating weighted integrals", "authors": ["L. Plaskota", "G.W. Wasilkowski", "Y. Zhao"], "venue": "J. Complexity,", "year": 2009}, {"title": "Bayesian Quadrature in Nonlinear Filtering", "authors": ["J. Pr\u00fcher", "M. \u0160imandl"], "venue": "In 12th I. Conf. Inform. Control Autom. Robot.,", "year": 2015}, {"title": "Bayesian Monte Carlo", "authors": ["C.E. Rasmussen", "Z. Ghahramani"], "venue": "In Adv. Neur. Inf. Proc. Sys.,", "year": 2002}, {"title": "Monte Carlo statistical methods", "authors": ["C. Robert", "G. Casella"], "venue": "Springer Science & Business Media,", "year": 2013}, {"title": "An introduction to ordinary differential equations", "authors": ["J.C. Robinson"], "year": 2004}, {"title": "On the relation between Gaussian process quadratures and sigma-point methods", "authors": ["S. S\u00e4rkk\u00e4", "J. Hartikainen", "L. Svensson", "F. Sandblom"], "year": 2015}, {"title": "Data spectroscopy: Eigenspaces of convolution operators and clustering", "authors": ["T. Shi", "M. Belkin", "B. Yu"], "venue": "Ann. Statist.,", "year": 2009}, {"title": "Trace Ideals and Their Applications", "authors": ["B. Simon"], "year": 1979}, {"title": "A Hilbert space embedding for distributions", "authors": ["A. Smola", "A. Gretton", "L. Song", "B. Sch\u00f6lkopf"], "venue": "In Algorithmic Learn. Theor.,", "year": 2007}, {"title": "Numerical cubature on scattered data by radial basis functions", "authors": ["A. Sommariva", "M. Vianello"], "year": 2006}, {"title": "Special Functions: An Introduction to the Classical Functions of Mathematical Physics", "authors": ["N.M. Temme"], "year": 1996}, {"title": "Scattered Data Approximation", "authors": ["H. Wendland"], "year": 2004}, {"title": "Towards Automatic Model Comparison: An Adaptive Sequential Monte Carlo Approach", "authors": ["Y. Zhou", "A.M. Johansen", "J.A.D. Aston"], "venue": "J. Comput. Graph. Statist.,", "year": 2016}], "id": "SP:7b4d3112d4e08c99d78739b2db75408c8bcd883e", "authors": [{"name": "Fran\u00e7ois-Xavier Briol", "affiliations": []}, {"name": "Chris J. Oates", "affiliations": []}, {"name": "Jon Cockayne", "affiliations": []}, {"name": "Wilson Ye Chen", "affiliations": []}, {"name": "Mark Girolami", "affiliations": []}], "abstractText": "The standard Kernel Quadrature method for numerical integration with random point sets (also called Bayesian Monte Carlo) is known to converge in root mean square error at a rate determined by the ratio s/d, where s and d encode the smoothness and dimension of the integrand. However, an empirical investigation reveals that the rate constant C is highly sensitive to the distribution of the random points. In contrast to standard Monte Carlo integration, for which optimal importance sampling is wellunderstood, the sampling distribution that minimises C for Kernel Quadrature does not admit a closed form. This paper argues that the practical choice of sampling distribution is an important open problem. One solution is considered; a novel automatic approach based on adaptive tempering and sequential Monte Carlo. Empirical results demonstrate a dramatic reduction in integration error of up to 4 orders of magnitude can be achieved with the proposed method.", "title": "On the Sampling Problem for Kernel Quadrature"}